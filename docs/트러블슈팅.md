# 트러블슈팅

## Q: 백업 파일이 생성되지 않음

### 확인 사항

1. **10분 내에 수정된 파일이 있는가?**

```bash
find /home/kiam -name "*.php" -mmin -10
```

수정된 파일이 없으면 백업이 생성되지 않습니다. (정상 동작)

2. **권한이 있는가?**

```bash
ls -ld /disk/backup/edit/
# 출력: drwxr-xr-x ... /disk/backup/edit/

# 쓰기 권한 확인
touch /disk/backup/edit/test.txt && rm /disk/backup/edit/test.txt
```

3. **스크립트가 실행되는가?**

```bash
# 수동으로 실행해보기
/usr/local/bin/backup-kiamphp.sh

# 에러 확인
/usr/local/bin/backup-kiamphp.sh 2>&1 | tee /tmp/backup-debug.log
```

4. **Cron이 실행되는가?**

```bash
# Cron 작업 확인
crontab -l | grep backup

# Cron 로그 확인 (CentOS/RHEL)
tail -50 /var/log/cron

# Cron 로그 확인 (Ubuntu/Debian)
grep CRON /var/log/auth.log | tail -50

# 또는 시스템 로그
journalctl -u cron --no-pager -n 50
```

### 해결 방법

#### 경우 1: Cron 작업이 등록되지 않음

```bash
# Cron 다시 등록
sudo bash scripts/install.sh

# 또는 수동 등록
(crontab -l 2>/dev/null; echo "*/10 * * * * /usr/local/bin/backup-kiamphp.sh && /usr/local/bin/backup-system-config.sh") | crontab -
```

#### 경우 2: 스크립트 경로가 잘못됨

```bash
# 스크립트 위치 확인
which backup-kiamphp.sh
ls -l /usr/local/bin/backup-*.sh

# 없으면 재설치
sudo bash scripts/install.sh
```

#### 경우 3: 디렉토리 권한 문제

```bash
# 백업 디렉토리 권한 수정
sudo chmod 755 /disk/backup/edit/
sudo chmod 755 /disk/backup/edit/kiamphp/
sudo chmod 755 /disk/backup/edit/system/
sudo chmod 755 /disk/backup/edit/kiamphp/.meta/
sudo chmod 755 /disk/backup/edit/system/.meta/
```

---

## Q: "Permission denied" 에러

### 증상

```
cp: cannot create regular file '/disk/backup/edit/kiamphp/...': Permission denied
```

### 원인

- 백업 디렉토리 권한 부족
- 로그 파일 권한 부족
- Cron이 일반 사용자로 실행됨

### 해결 방법

```bash
# 1. 디렉토리 권한 확인
ls -ld /disk/backup/edit/

# 2. 현재 사용자로 쓰기 테스트
touch /disk/backup/edit/test.txt && rm /disk/backup/edit/test.txt

# 3. 권한 수정 (필요시)
sudo chmod 755 /disk/backup/edit/
sudo chmod 755 /disk/backup/edit/kiamphp/
sudo chmod 755 /disk/backup/edit/system/

# 4. 로그 파일 권한
sudo chmod 644 /var/log/backup-*.log
sudo chown root:root /var/log/backup-*.log

# 5. 다시 테스트
/usr/local/bin/backup-kiamphp.sh
```

---

## Q: 디스크 공간 부족

### 증상

```
No space left on device
/ dev/nvme0n1p1 is 100% full
```

### 원인 분석

```bash
# 1. 백업 디렉토리 용량 확인
du -sh /disk/backup/edit/

# 2. 상세 분석
du -sh /disk/backup/edit/* | sort -rh

# 3. 가장 오래된 파일 확인
find /disk/backup/edit -name "*.bak" -mtime +10 | wc -l
```

### 해결 방법

#### 방법 1: 보관 기간 단축

```bash
# 설정 파일 수정
vi config/config.sh

# RETENTION_DAYS를 줄임 (예: 5일)
# RETENTION_DAYS=5

# 다음 Cron 실행 시 자동 정리됨
```

#### 방법 2: 수동 정리

```bash
# 안전하게 테스트
find /disk/backup/edit -name "*.bak" -mtime +7 -type f | head -20

# 실제 삭제
find /disk/backup/edit -name "*.bak" -mtime +7 -delete
find /disk/backup/edit -name "*.meta" -mtime +7 -delete

# 확인
du -sh /disk/backup/edit/
```

#### 방법 3: 메타정보 정리

```bash
# 메타정보만 삭제 (백업 파일은 유지)
find /disk/backup/edit -name "*.meta" -mtime +30 -delete

# 용량 확인
du -sh /disk/backup/edit/
```

#### 방법 4: 압축 (선택)

```bash
# 백업 파일 압축
cd /disk/backup/edit/kiamphp
for f in *.bak; do
  if [ ! -f "$f.gz" ]; then
    gzip "$f"
  fi
done

# 확인
du -sh /disk/backup/edit/kiamphp/
```

---

## Q: Cron 작업이 실행되지 않음

### 증상

```bash
# Crontab 등록됨
crontab -l | grep backup
*/10 * * * * /usr/local/bin/backup-kiamphp.sh && ...

# 하지만 백업 파일 생성 안 됨
ls -lh /disk/backup/edit/kiamphp/ | wc -l
# 0
```

### 원인 분석

```bash
# 1. Cron 서비스 상태 확인
sudo systemctl status crond  # CentOS/RHEL
sudo systemctl status cron   # Ubuntu/Debian

# 2. Cron 서비스 로그 확인
sudo tail -100 /var/log/cron  # CentOS/RHEL
grep CRON /var/log/auth.log | tail -100  # Ubuntu/Debian

# 3. 시스템 저널 확인
sudo journalctl -u cron -n 100 --no-pager

# 4. 수동 실행 테스트
/usr/local/bin/backup-kiamphp.sh
echo $?  # 0이면 성공
```

### 해결 방법

#### 경우 1: Cron 서비스가 비활성화됨

```bash
# 서비스 시작
sudo systemctl start crond  # CentOS
sudo systemctl start cron   # Ubuntu

# 자동 시작 설정
sudo systemctl enable crond
sudo systemctl enable cron
```

#### 경우 2: 스크립트 에러

```bash
# 스크립트 직접 실행
bash -x /usr/local/bin/backup-kiamphp.sh 2>&1 | tee /tmp/debug.log

# 에러 메시지 확인
cat /tmp/debug.log | grep -i error
```

#### 경우 3: 환경 변수 문제

```bash
# Cron 환경에서 실행하기
env -i HOME=$HOME /bin/sh -c 'crontab -l | grep backup | /bin/sh'

# 절대 경로 사용 확인
which bash
# /bin/bash

# Cron 작업 수정
crontab -e
# #!/bin/bash 추가 (첫 줄)
# 절대 경로 사용: /usr/local/bin/backup-kiamphp.sh
```

#### 경우 4: 파일 권한 문제

```bash
# 스크립트 권한 확인
ls -l /usr/local/bin/backup-*.sh
# -rwxr-xr-x

# 권한 수정 (필요시)
sudo chmod 755 /usr/local/bin/backup-*.sh
```

---

## Q: JSON 메타정보 파싱 에러

### 증상

```bash
view-backup-versions.sh index.php
# jq: parse error: Expected value before '\'
```

### 원인

- jq 미설치
- 메타정보 파일 손상
- 특수문자 인코딩 문제

### 해결 방법

```bash
# 1. jq 설치
sudo yum install -y jq  # CentOS/RHEL
sudo apt-get install -y jq  # Ubuntu/Debian

# 2. 메타정보 파일 확인
cat /disk/backup/edit/kiamphp/.meta/index.php-.-20251130-120000.meta

# 3. 파일이 손상되면 수동 복구 필요
# 또는 Python 사용
python3 -m json.tool /disk/backup/edit/kiamphp/.meta/index.php-.-20251130-120000.meta
```

---

## Q: 백업 파일 MD5 해시 불일치

### 증상

```bash
HASH1=$(md5sum /disk/backup/edit/kiamphp/index.php-.-20251130-120000.bak | awk '{print $1}')
HASH2=$(cat /disk/backup/edit/kiamphp/.meta/index.php-.-20251130-120000.meta | jq -r '.md5_hash')

if [ "$HASH1" != "$HASH2" ]; then
  echo "해시 불일치 감지!"
fi
```

### 원인

- 백업 파일 손상
- 메타정보 파일 손상
- 파일 시스템 에러

### 해결 방법

```bash
# 1. 파일 무결성 확인
file /disk/backup/edit/kiamphp/index.php-.-20251130-120000.bak

# 2. 파일이 손상되면 삭제
rm /disk/backup/edit/kiamphp/index.php-.-20251130-120000.bak
rm /disk/backup/edit/kiamphp/.meta/index.php-.-20251130-120000.meta

# 3. 다음 백업 주기 때 자동 생성됨 (원본 파일 수정 필요)
touch /home/kiam/index.php

# 4. Cron 또는 수동 실행
/usr/local/bin/backup-kiamphp.sh
```

---

## Q: 특정 파일이 백업되지 않음

### 증상

```bash
# 파일은 수정되었지만 백업 안 됨
ls -lh /home/kiam/config.php

# 백업 파일 검색해도 없음
find /disk/backup/edit/kiamphp -name "config.php-*"
```

### 원인 분석

```bash
# 1. 파일 수정 시간 확인
stat /home/kiam/config.php | grep Modify

# 2. 현재 시간과 비교
date

# 3. 10분 이내 수정되었는가?
find /home/kiam -name "config.php" -mmin -10
```

### 해결 방법

```bash
# 경우 1: 10분 이상 경과한 경우
# -> 파일을 수정하면 다음 Cron 실행 시 백업됨

# 경우 2: 경로 확인
# config.php가 /home/kiam 하위에 있는가?
ls -ld /home/kiam
find /home/kiam -name "config.php"

# 경우 3: 파일 권한 확인
ls -l /home/kiam/config.php
# 읽기 권한이 있어야 함

# 경우 4: 수동 백업 강제 실행
/usr/local/bin/backup-kiamphp.sh
```

---

## Q: 로그 파일이 너무 커짐

### 증상

```bash
ls -lh /var/log/backup-*.log
# -rw-r--r-- ... 1.5G /var/log/backup-kiamphp.log
```

### 원인

- 장시간 운영
- Cron이 너무 자주 실행됨 (예: */1)

### 해결 방법

#### 방법 1: 로그 로테이션 설정

```bash
# logrotate 설정 파일 생성
sudo vi /etc/logrotate.d/backup-system

# 다음 내용 추가
/var/log/backup-*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
}

# 테스트
sudo logrotate -d /etc/logrotate.d/backup-system

# 적용
sudo logrotate -f /etc/logrotate.d/backup-system
```

#### 방법 2: 로그 파일 정리

```bash
# 로그 파일 초기화 (현재 로그 삭제)
sudo truncate -s 0 /var/log/backup-kiamphp.log
sudo truncate -s 0 /var/log/backup-system-config.log

# 또는 백업 후 삭제
sudo mv /var/log/backup-kiamphp.log /var/log/backup-kiamphp.log.backup
sudo mv /var/log/backup-system-config.log /var/log/backup-system-config.log.backup

# 새로운 로그 파일 생성 (다음 Cron 실행 시 자동)
touch /var/log/backup-kiamphp.log
touch /var/log/backup-system-config.log
```

#### 방법 3: Cron 주기 조정

```bash
# 너무 자주 실행되는 경우
vi config/config.sh

# CRON_INTERVAL을 늘림
# CRON_INTERVAL="*/10"  # 10분마다 (기본)
# CRON_INTERVAL="*/30"  # 30분마다

# 재설치
sudo bash scripts/install.sh
```

---

## Q: 설정 파일 백업이 작동하지 않음

### 증상

```bash
ls -lh /disk/backup/edit/system/
# 파일이 없거나 거의 없음
```

### 원인 분석

```bash
# 1. 설정 파일 존재 여부 확인
ls -la /etc/mysql/
ls -la /etc/php/
ls -la /etc/apache2/

# 2. 권한 확인 (root 필요)
sudo ls -la /etc/mysql/*.cnf

# 3. 수정 시간 확인
stat /etc/mysql/mysql.conf.d/mysqld.cnf | grep Modify
```

### 해결 방법

```bash
# 1. Root 권한으로 실행
sudo /usr/local/bin/backup-system-config.sh

# 2. 에러 확인
sudo /usr/local/bin/backup-system-config.sh 2>&1 | tee /tmp/config-backup-debug.log

# 3. 로그 확인
sudo tail -f /var/log/backup-system-config.log

# 4. 수동으로 파일 수정 후 백업
sudo touch /etc/mysql/mysql.conf.d/mysqld.cnf
sudo /usr/local/bin/backup-system-config.sh

# 5. 결과 확인
ls -lh /disk/backup/edit/system/
```

---

## Q: "No such file or directory" 에러

### 증상

```
find: '/home/kiam': No such file or directory
```

### 원인

- 소스 디렉토리가 존재하지 않음
- 마운트 해제됨
- 잘못된 경로 설정

### 해결 방법

```bash
# 1. 소스 디렉토리 확인
ls -ld /home/kiam

# 2. 마운트 확인
mount | grep /home

# 3. 설정 파일 확인
cat config/config.sh | grep SOURCE_PHP_DIR

# 4. 경로 수정 (필요시)
vi config/config.sh
# SOURCE_PHP_DIR="/correct/path"

# 5. 다시 실행
/usr/local/bin/backup-kiamphp.sh
```

---

## 도움이 필요하신가요?

더 도움이 필요하면:

1. 로그 파일 확인: `/var/log/backup-*.log`
2. 수동 실행: `/usr/local/bin/backup-kiamphp.sh 2>&1`
3. GitHub 이슈: https://github.com/onlyonemaster/backup-system/issues
