# ì‚¬ìš©ì„¤ëª…ì„œ

## ë°±ì—… íŒŒì¼ ì¡°íšŒ

### PHP ë°±ì—… íŒŒì¼ ì¡°íšŒ

```bash
# ëª¨ë“  PHP ë°±ì—… íŒŒì¼ ëª©ë¡
ls -lh /disk/backup/edit/kiamphp/

# íŠ¹ì • íŒŒì¼ì˜ ëª¨ë“  ë²„ì „ ì¡°íšŒ
ls -lh /disk/backup/edit/kiamphp/index.php-*

# ìµœì‹  ë°±ì—… íŒŒì¼ ì¡°íšŒ
ls -lht /disk/backup/edit/kiamphp/ | head -10
```

### ì„¤ì • íŒŒì¼ ë°±ì—… ì¡°íšŒ

```bash
# ëª¨ë“  ì„¤ì • ë°±ì—… íŒŒì¼ ëª©ë¡
ls -lh /disk/backup/edit/system/

# MySQL ì„¤ì • ë°±ì—…ë§Œ ì¡°íšŒ
ls -lh /disk/backup/edit/system/mysqld.cnf-*

# Apache ì„¤ì • ë°±ì—…ë§Œ ì¡°íšŒ
ls -lh /disk/backup/edit/system/httpd.conf-*
```

## ë©”íƒ€ì •ë³´ í™•ì¸

### JSON ë©”íƒ€ì •ë³´ ë³´ê¸°

```bash
# íŠ¹ì • íŒŒì¼ì˜ ë©”íƒ€ì •ë³´ ë³´ê¸°
cat /disk/backup/edit/kiamphp/.meta/index.php-.-20251130-120000.meta

# ëª¨ë“  ë©”íƒ€ì •ë³´ ë³´ê¸°
cat /disk/backup/edit/kiamphp/.meta/*.meta

# ë³´ê¸° ì¢‹ê²Œ í¬ë§· (jq ì„¤ì¹˜ í•„ìš”)
cat /disk/backup/edit/kiamphp/.meta/index.php-.-20251130-120000.meta | jq .
```

### JSON ë©”íƒ€ì •ë³´ êµ¬ì¡°

ê° ë©”íƒ€ì •ë³´ íŒŒì¼ì€ ë‹¤ìŒê³¼ ê°™ì€ ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤:

```json
{
  "timestamp": "20251130-120000",          # ë°±ì—… ì‹œê°„ (YYYYmmdd-HHmmss)
  "original_path": "index.php",            # ì›ë³¸ íŒŒì¼ ê²½ë¡œ (SOURCE_DIR ê¸°ì¤€)
  "file_type": "php",                      # íŒŒì¼ íƒ€ì… (php, cnf, ini, conf ë“±)
  "source_directory": "/home/kiam",        # ì›ë³¸ ì†ŒìŠ¤ ë””ë ‰í† ë¦¬
  "backup_filename": "index.php-.-20251130-120000.bak",  # ë°±ì—… íŒŒì¼ëª…
  "file_size_bytes": 2048,                 # íŒŒì¼ í¬ê¸° (ë°”ì´íŠ¸)
  "total_lines": 100,                      # ì´ ë¼ì¸ ìˆ˜
  "md5_hash": "a98a8b86bdf7805b1ac551eb9a885ff5",  # ë¬´ê²°ì„± ê²€ì¦ í•´ì‹œ
  "backup_datetime": "2025-11-30 12:00:00",  # ë°±ì—… ì‹œê°„ (ISO 8601)
  "korean_date": "2025ë…„ 11ì›” 30ì¼ ì¼ 12:00:00 PM",  # í•œê¸€ í˜•ì‹ ì‹œê°„
  "changes": "15 lines modified",          # ì´ì „ ë²„ì „ê³¼ì˜ ì°¨ì´
  "previous_backup": "index.php-.-20251130-115900.bak"  # ì´ì „ ë°±ì—… íŒŒì¼ëª…
}
```

## ë²„ì „ ì¡°íšŒ ë„êµ¬

### view-backup-versions.sh ì‚¬ìš©ë²•

```bash
# ê¸°ë³¸ ë¬¸ë²•
view-backup-versions.sh <íŒŒì¼ëª…> [latest|diff|all]

# ì˜µì…˜ ì„¤ëª…
# latest : ìµœì‹  ë²„ì „ë§Œ í‘œì‹œ
# diff   : ìµœì‹  2ê°œ ë²„ì „ ë¹„êµ
# all    : ëª¨ë“  ë²„ì „ í‘œì‹œ (ê¸°ë³¸ê°’)
```

### ì‚¬ìš© ì˜ˆì‹œ

```bash
# ì˜ˆì‹œ 1: index.phpì˜ ëª¨ë“  ë²„ì „ ì¡°íšŒ
view-backup-versions.sh index.php

# ì˜ˆì‹œ 2: mysqld.cnfì˜ ìµœì‹  ë²„ì „ë§Œ ì¡°íšŒ
view-backup-versions.sh mysqld.cnf latest

# ì˜ˆì‹œ 3: php.iniì˜ ìµœì‹  2ê°œ ë²„ì „ ë¹„êµ
view-backup-versions.sh php.ini diff

# ì˜ˆì‹œ 4: êµ¬ì²´ì  ì§€ì •
view-backup-versions.sh index.php all
```

### ì¶œë ¥ ì˜ˆì‹œ

#### ëª¨ë“  ë²„ì „ ì¡°íšŒ (index.php all)

```
ğŸ“š index.php ì˜ ë°±ì—… ë²„ì „ ëª©ë¡ (PHP)
=======================================

[1] 20251130-120000
    í¬ê¸°: 2048 bytes | ë¼ì¸: 100 | MD5: a98a8b86...
    ë³€ê²½: 15 lines modified
    íŒŒì¼: index.php-.-20251130-120000.bak

[2] 20251130-115900
    í¬ê¸°: 1980 bytes | ë¼ì¸: 95 | MD5: a98a8b86...
    ë³€ê²½: 3 lines modified
    íŒŒì¼: index.php-.-20251130-115900.bak

[3] 20251130-115800
    í¬ê¸°: 1977 bytes | ë¼ì¸: 92 | MD5: b12cdefg...
    ë³€ê²½: initial backup
    íŒŒì¼: index.php-.-20251130-115800.bak

ì´ 3 ê°œì˜ ë°±ì—… ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤.
```

#### ìµœì‹  ë²„ì „ë§Œ ì¡°íšŒ (index.php latest)

```
ìµœì‹  ë²„ì „:

{
  "timestamp": "20251130-120000",
  "original_path": "index.php",
  "file_type": "php",
  "source_directory": "/home/kiam",
  "backup_filename": "index.php-.-20251130-120000.bak",
  "file_size_bytes": 2048,
  "total_lines": 100,
  "md5_hash": "a98a8b86bdf7805b1ac551eb9a885ff5",
  "backup_datetime": "2025-11-30 12:00:00",
  "korean_date": "2025ë…„ 11ì›” 30ì¼ ì¼ 12:00:00 PM",
  "changes": "15 lines modified",
  "previous_backup": "index.php-.-20251130-115900.bak"
}
```

## íŒŒì¼ ë³µì›

### íŠ¹ì • ë²„ì „ìœ¼ë¡œ ë³µì›

```bash
# 1. ë°±ì—… íŒŒì¼ í™•ì¸
ls -lh /disk/backup/edit/kiamphp/index.php-*

# 2. íŠ¹ì • ë²„ì „ ë³µì›
cp /disk/backup/edit/kiamphp/index.php-.-20251130-115900.bak /home/kiam/index.php

# 3. ë³µì› í™•ì¸
ls -lh /home/kiam/index.php
cat /home/kiam/index.php | head -20
```

### ì„¤ì • íŒŒì¼ ë³µì›

```bash
# MySQL ì„¤ì • ë³µì›
sudo cp /disk/backup/edit/system/mysqld.cnf-mysql.conf.d-20251130-120000.bak \
        /etc/mysql/mysql.conf.d/mysqld.cnf

# Apache ì„¤ì • ë³µì›
sudo cp /disk/backup/edit/system/apache2.conf-.-20251130-120000.bak \
        /etc/apache2/apache2.conf

# PHP ì„¤ì • ë³µì›
sudo cp /disk/backup/edit/system/php.ini-php.d-20251130-120000.bak \
        /etc/php/7.4/fpm/php.ini

# ë³µì› í›„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
sudo systemctl restart mysql
sudo systemctl restart apache2
sudo systemctl restart php-fpm
```

### ë³µì› ì „ ê²€ì¦

```bash
# MD5 í•´ì‹œë¡œ ë¬´ê²°ì„± í™•ì¸
ORIGINAL_HASH=$(jq -r '.md5_hash' /disk/backup/edit/kiamphp/.meta/index.php-.-20251130-115900.meta)
BACKUP_HASH=$(md5sum /disk/backup/edit/kiamphp/index.php-.-20251130-115900.bak | awk '{print $1}')

if [ "$ORIGINAL_HASH" = "$BACKUP_HASH" ]; then
    echo "ë¬´ê²°ì„± ê²€ì¦: í†µê³¼"
else
    echo "ë¬´ê²°ì„± ê²€ì¦: ì‹¤íŒ¨"
    exit 1
fi

# ì´ì œ ë³µì› ì§„í–‰
cp /disk/backup/edit/kiamphp/index.php-.-20251130-115900.bak /home/kiam/index.php
```

## ë¡œê·¸ í™•ì¸

### PHP ë°±ì—… ë¡œê·¸

```bash
# ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
tail -f /var/log/backup-kiamphp.log

# ìµœê·¼ 50ì¤„ ì¡°íšŒ
tail -50 /var/log/backup-kiamphp.log

# íŠ¹ì • íŒŒì¼ë§Œ ê²€ìƒ‰
grep "index.php" /var/log/backup-kiamphp.log

# íŠ¹ì • ì‹œê°„ëŒ€ ë¡œê·¸ ì¡°íšŒ
grep "2025-11-30 12:" /var/log/backup-kiamphp.log

# ì—ëŸ¬ë§Œ ê²€ìƒ‰
grep "ERROR\|error\|failed" /var/log/backup-kiamphp.log
```

### ì„¤ì • ë°±ì—… ë¡œê·¸

```bash
# ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
tail -f /var/log/backup-system-config.log

# MySQL ì„¤ì • ë°±ì—…ë§Œ ê²€ìƒ‰
grep "\[CNF\]" /var/log/backup-system-config.log

# Apache ì„¤ì • ë°±ì—…ë§Œ ê²€ìƒ‰
grep "\[CONF\]" /var/log/backup-system-config.log

# í•˜ë£¨ ë™ì•ˆì˜ ë¡œê·¸
grep "2025-11-30" /var/log/backup-system-config.log
```

### ë¡œê·¸ ë¶„ì„

```bash
# ì˜¤ëŠ˜ ë°±ì—…ëœ íŒŒì¼ ê°œìˆ˜
grep "$(date '+%Y-%m-%d')" /var/log/backup-kiamphp.log | wc -l

# ê°€ì¥ ë§ì´ ë°±ì—…ëœ íŒŒì¼ TOP 10
grep "Backed up:" /var/log/backup-kiamphp.log | \
  awk '{print $NF}' | cut -d'(' -f1 | sort | uniq -c | sort -rn | head -10

# ì´ ë°±ì—… ìš©ëŸ‰
grep "Backed up:" /var/log/backup-kiamphp.log | \
  awk '{print $(NF-2)}' | sed 's/[^0-9]*//g' | \
  awk '{sum+=$1} END {print sum / 1024 / 1024 "MB"}'
```

## ëª¨ë‹ˆí„°ë§

### ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸

```bash
# ë°±ì—… ì‹œìŠ¤í…œ ì „ì²´ ìš©ëŸ‰
du -sh /disk/backup/edit/

# PHP ë°±ì—… ìš©ëŸ‰
du -sh /disk/backup/edit/kiamphp/

# ì„¤ì • ë°±ì—… ìš©ëŸ‰
du -sh /disk/backup/edit/system/

# ìƒì„¸ ë¶„ì„
du -sh /disk/backup/edit/* | sort -rh
```

### ë°±ì—… íŒŒì¼ í†µê³„

```bash
# ì´ ë°±ì—… íŒŒì¼ ê°œìˆ˜
find /disk/backup/edit -name "*.bak" | wc -l

# PHP ë°±ì—… íŒŒì¼ ê°œìˆ˜
find /disk/backup/edit/kiamphp -name "*.bak" | wc -l

# ì„¤ì • ë°±ì—… íŒŒì¼ ê°œìˆ˜
find /disk/backup/edit/system -name "*.bak" | wc -l

# ë©”íƒ€ íŒŒì¼ ê°œìˆ˜
find /disk/backup/edit -name "*.meta" | wc -l
```

### Cron ìƒíƒœ í™•ì¸

```bash
# Cron ì‘ì—… í™•ì¸
crontab -l | grep backup

# Cron ì„œë¹„ìŠ¤ ìƒíƒœ
systemctl status crond

# Cron ë¡œê·¸
tail -f /var/log/cron | grep backup
```

## ìë™ ì •ë¦¬

ë°±ì—… ì‹œìŠ¤í…œì€ ìë™ìœ¼ë¡œ ì˜¤ë˜ëœ íŒŒì¼ì„ ì‚­ì œí•©ë‹ˆë‹¤.

### ìë™ ì •ë¦¬ ì„¤ì •

```bash
# ì„¤ì • íŒŒì¼ì—ì„œ í™•ì¸
cat config/config.sh | grep RETENTION_DAYS

# RETENTION_DAYS=10ì´ë©´ 10ì¼ ì´ìƒ ê²½ê³¼ íŒŒì¼ ìë™ ì‚­ì œ
```

### ìˆ˜ë™ ì •ë¦¬

```bash
# 7ì¼ ì´ìƒ ê²½ê³¼ íŒŒì¼ ì‚­ì œ
find /disk/backup/edit -name "*.bak" -mtime +7 -delete
find /disk/backup/edit -name "*.meta" -mtime +7 -delete

# í™•ì¸
du -sh /disk/backup/edit/
```

## ì„±ëŠ¥ ìµœì í™”

### 1. Cron ì£¼ê¸° ì¡°ì •

```bash
# ê¸°ë³¸: 10ë¶„ë§ˆë‹¤ (ë³€ê²½ ê°ì§€ ì‹œê°„ í‰ê·  5ë¶„)
# ë” ë¹ ë¥¸ ê°ì§€ í•„ìš”ì‹œ:
vi config/config.sh
# CRON_INTERVAL="*/5"  # 5ë¶„ë§ˆë‹¤

# ëœ ìì£¼ í•„ìš”ì‹œ:
# CRON_INTERVAL="*/30" # 30ë¶„ë§ˆë‹¤
```

### 2. ë³´ê´€ ê¸°ê°„ ë‹¨ì¶•

```bash
# ë””ìŠ¤í¬ ë¶€ì¡±ì‹œ
vi config/config.sh
# RETENTION_DAYS=5  # 5ì¼ë¡œ ë‹¨ì¶•

# ìˆ˜ë™ ì •ë¦¬ (ì¦‰ì‹œ)
find /disk/backup/edit -name "*.bak" -mtime +5 -delete
```

### 3. ë©”íƒ€ì •ë³´ ì¸ë±ì‹±

```bash
# ë©”íƒ€ì •ë³´ë¡œ ì¸ë±ìŠ¤ ìƒì„± (ì„ íƒ)
for f in /disk/backup/edit/**/.meta/*.meta; do
  FILENAME=$(jq -r '.backup_filename' "$f")
  echo "$FILENAME" >> /tmp/backup-index.txt
done
sort /tmp/backup-index.txt | uniq > /tmp/backup-index-unique.txt
```

## ì•ˆì „ íŒ

### 1. ì •ê¸°ì ì¸ ë³µì› í…ŒìŠ¤íŠ¸

```bash
# ì›” 1íšŒ ë³µì› í…ŒìŠ¤íŠ¸ ì‹¤í–‰
TEST_DIR="/tmp/restore-test-$(date +%Y%m%d)"
mkdir -p "$TEST_DIR"

# ë°±ì—… íŒŒì¼ ë³µì‚¬ í›„ ê²€ì¦
cp /disk/backup/edit/kiamphp/index.php-.-20251130-120000.bak "$TEST_DIR/"
md5sum "$TEST_DIR/index.php-.-20251130-120000.bak"

rm -rf "$TEST_DIR"
echo "ë³µì› í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
```

### 2. ë©”íƒ€ì •ë³´ ë°±ì—…

```bash
# ë©”íƒ€ì •ë³´ë§Œ ë³„ë„ ë³´ê´€
tar czf /disk/backup/metadata-$(date +%Y%m%d).tar.gz \
    /disk/backup/edit/**/.meta/

ls -lh /disk/backup/metadata-*.tar.gz
```

### 3. ì›ê²© ë³µì‚¬

```bash
# ë‹¤ë¥¸ ì„œë²„ë¡œ ë°±ì—… ë³µì‚¬ (ì„ íƒ)
rsync -avz /disk/backup/edit/kiamphp/ \
      remote_user@remote_host:/disk/backup/kiamphp-replica/
```

## FAQ

### Q: ë°±ì—… íŒŒì¼ ì´ë¦„ì´ ë„ˆë¬´ ê¸´ê°€ìš”?

A: íŒŒì¼ëª… êµ¬ì¡°:
- `íŒŒì¼ëª…-ê²½ë¡œ-ë‚ ì§œì‹œê°„.bak`
- ì˜ˆ: `index.php-.-20251130-120000.bak`
  - `index.php`: íŒŒì¼ëª…
  - `-.-`: ê²½ë¡œ êµ¬ë¶„ì (ë£¨íŠ¸ ë””ë ‰í† ë¦¬ í‘œì‹œ)
  - `20251130-120000`: ë°±ì—… ì‹œê°„

### Q: ë°±ì—… íŒŒì¼ì„ ì••ì¶•í•  ìˆ˜ ìˆë‚˜ìš”?

A: í˜„ì¬ëŠ” ë¯¸ì§€ì›ì…ë‹ˆë‹¤. í–¥í›„ ë²„ì „ì—ì„œ gzip ì••ì¶• ì˜µì…˜ ì¶”ê°€ ì˜ˆì •ì…ë‹ˆë‹¤.

### Q: ë‹¤ë¥¸ ì„œë²„ë¡œ ë°±ì—…ì„ ë³µì‚¬í•  ìˆ˜ ìˆë‚˜ìš”?

A: ë„¤, rsync ë˜ëŠ” scpë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:

```bash
# rsyncë¡œ ë™ê¸°í™”
rsync -avz /disk/backup/edit/ remote:/disk/backup/edit/

# scpë¡œ íŠ¹ì • íŒŒì¼ ë³µì‚¬
scp /disk/backup/edit/kiamphp/index.php-.-*.bak remote:/backup/
```

### Q: ë°±ì—…ì„ ì•”í˜¸í™”í•  ìˆ˜ ìˆë‚˜ìš”?

A: GPGë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜ë™ìœ¼ë¡œ ì•”í˜¸í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```bash
# ì•”í˜¸í™”
gpg -c /disk/backup/edit/kiamphp/index.php-.-20251130-120000.bak

# ë³µí˜¸í™”
gpg /disk/backup/edit/kiamphp/index.php-.-20251130-120000.bak.gpg
```
